% THIS IS SIGPROC-SP.TEX - VERSION 3.1
% WORKS WITH V3.2SP OF ACM_PROC_ARTICLE-SP.CLS
% APRIL 2009
%
% It is an example file showing how to use the 'acm_proc_article-sp.cls' V3.2SP
% LaTeX2e document class file for Conference Proceedings submissions.
% ----------------------------------------------------------------------------------------------------------------
% This .tex file (and associated .cls V3.2SP) *DOES NOT* produce:
%       1) The Permission Statement
%       2) The Conference (location) Info information
%       3) The Copyright Line with ACM data
%       4) Page numbering
% ---------------------------------------------------------------------------------------------------------------
% It is an example which *does* use the .bib file (from which the .bbl file
% is produced).
% REMEMBER HOWEVER: After having produced the .bbl file,
% and prior to final submission,
% you need to 'insert'  your .bbl file into your source .tex file so as to provide
% ONE 'self-contained' source file.
%
% Questions regarding SIGS should be sent to
% Adrienne Griscti ---> griscti@acm.org
%
% Questions/suggestions regarding the guidelines, .tex and .cls files, etc. to
% Gerald Murray ---> murray@hq.acm.org
%
% For tracking purposes - this is V3.1SP - APRIL 2009

\documentclass{acm_proc_article-sp}

%\permission{Permission to make digital or hard copies of all or part of this work for personal or classroom use is granted without fee provided that copies are not made or distributed for profit or commercial advantage and that copies bear this notice and the full citation on the first page. Copyrights for components of this work owned by others than ACM must be honored. Abstracting with credit is permitted. To copy otherwise, or republish, to post on servers or to redistribute to lists, requires prior specific permission and/or a fee. Request permissions from Permissions@acm.org.}
%\conferenceinfo{SIGSIM-PADS'15,}{June 10--12, 2015, London, United Kingdom.}
%\copyrightetc{\copyright~2015 ACM \the\acmcopyr}
%\crdata{ISBN 978-1-4503-3583-6/15/06\$15.00.\\
%DOI: http://dx.doi.org/10.1145/2769458.2769480}

% *** CITATION PACKAGES ***
\usepackage{cite}

% *** MATH PACKAGES ***
\usepackage{amsmath}
\usepackage{svg}

% *** PDF, URL AND HYPERLINK PACKAGES ***
\usepackage{url}
\usepackage{hyperref}
\usepackage{epigraph}

% *** ALGORITHM ***
\usepackage{algorithm}
\usepackage{algpseudocode}
\usepackage{hyperref}
\usepackage{booktabs}
\usepackage{enumitem}

% *** To balance reference page **1*
\usepackage{flushend}

\begin{document}

\title{The {\ttlit Virtual Time Subsystem} for Linux Kernel}
\subtitle{A patch is available as VirtualTimeKernel
\titlenote{https://github.com/littlepretty/VirtualTimeKernel}}
%
% You need the command \numberofauthors to handle the 'placement
% and alignment' of the authors beneath the title.
%
% For aesthetic reasons, we recommend 'three authors at a time'
% i.e. three 'name/affiliation blocks' be placed beneath the title.
%
% NOTE: You are NOT restricted in how many 'rows' of
% "name/affiliations" may appear. We just ask that you restrict
% the number of 'columns' to three.
%
% Because of the available 'opening page real-estate'
% we ask you to refrain from putting more than six authors
% (two rows with three columns) beneath the article title.
% More than six makes the first-page appear very cluttered indeed.
%
% Use the \alignauthor commands to handle the names
% and affiliations for an 'aesthetic maximum' of six authors.
% Add names, affiliations, addresses for
% the seventh etc. author(s) as the argument for the
% \additionalauthors command.
% These 'additional authors' will be output/set for you
% without further effort on your part as the last section in
% the body of your article BEFORE References or any Appendices.

\numberofauthors{2} %  in this sample file, there are a *total*
% of EIGHT authors. SIX appear on the 'first-page' (for formatting
% reasons) and the remaining two appear in the \additionalauthors section.
%
\author{
% You can go ahead and credit any number of authors here,
% e.g. one 'row of three' or two rows (consisting of one row of three
% and a second row of one, two or three).
%
% The command \alignauthor (no curly braces needed) should
% precede each author name, affiliation/snail-mail address and
% e-mail address. Additionally, tag each line of
% affiliation/address with \affaddr, and tag the
% e-mail address with \email.
%
% 1st. author
\alignauthor
Jiaqi Yan\titlenote{Also the implementer}\\
       \affaddr{Illinois Institute of Technology}\\
       \affaddr{West 31st Street, Chicago}\\
       \affaddr{Illinois, USA}\\
       \email{jyan31@hawk.iit.edu}
% 2nd. author
\alignauthor 
Dong (Kevin) Jin\\
       \affaddr{Illinois Institute of Technology}\\
       \affaddr{West 31st Street, Chicago}\\
       \affaddr{Illinois, USA}\\
       \email{dong.jin@iit.edu}
}

\date{30 July 1999}
% Just remember to make sure that the TOTAL number of authors
% is the number that will appear on the first page PLUS the
% number that will appear in the \additionalauthors section.

\maketitle

\begin{abstract}
TODO
\end{abstract}

% A category with the (minimum) three required fields
\category{I.6.3}{Simulation and Modeling}{Application}[Miscellaneous]
\category{D.4.8}{Operating Systems}{Performance}[Measurement, Simulation]
%A category including the fourth, optional field follows...
\category{D.2.8}{Software Engineering}{Metrics}[complexity measures, performance measures]

\terms{Operating System}

\keywords{Virtual Time, Linux Kernel, Emulation} % NOT required for Proceedings

\section{Introduction}
What is virtual time? The short answer is: abstraction of time. When we abstract out the physical hardware, we can build an operating system that manage them intelligently; when we abstract out the behavior of operating system, we can run guest operating system inside a completely different host operating system; when we abstract the time of a process, what we can do is only limited by our imagination.

\section{The Features of Virtual Time Subsystem}
Virtual time, in essential, abstract time for processes from the operating system they reside on. With this abstraction, now we can dilate a process's clock or freeze a process's clock.

\subsection{Time Dilation}
When a process is \texttt{dilated}, it's clock advances by a factor faster or slower than wall-clock time. We borrow the definition of \textbf{Time Dilation Factor} from \cite{toinfinitybeyond}: the ratio of the time passing rate in physical world to the time passing rate perceived by process or virtual machine(VM). For example, when TDF equals 10, as 10 seconds elapsed in physical world, VM only perceives that 1 second passed. 

An interesting application of time dilation is to emulate a link with 1 Gbps bandwidth while we only have a 100 Mbps link. Ideally, when a process or a VM keeps sending data through this link for 1 seconds, it actually take 10 seconds in real world and hence 1 Gb data is transferred. In other words, the dilated process think the network bandwidth is 1 Gbps.

\subsection{Freeze}
Processes in any operating systems can be stopped and resumed. Usually it is through sending signal and handling signal. Imagine we not only stop the execution of a process, but also stop \textit{its} clock. Here "its" is not accurate; all processes inside a particular operating system share a global software clock. For example, process in Linux queries current time by \texttt{gettimeofday} system call. Now with virtual time, process finally have its own clock.

What a \textbf{freeze} does is both stop the execution of a process and the advance of its clock. A \textbf{unfreeze} does the opposite things: resume the execution and the clock. A once frozen process will not counting the freezing duration into its clock. A nontrivial application of freeze and unfreeze is to cooperate simulation and emulation of a system. For simulation, there is no the concept of real time; time advances according to software's wish. 

\section{The Interface of Virtual Time Subsystem}
\subsection{Linux Namespace}

The first namespace \texttt{mnt} namespace was introduced in Linux 2.4.19. 
Since then, more type of namespaces are implemented and currently we have totally 6 namespaces:
\begin{enumerate}
\item Mount namespaces(\texttt{CLONE\_NEWNS}), the first born, isolate the set of file system mount points seen by a group of process\cite{lwn:namespace:overview}. It is a more secure and flexible alternation of \texttt{chroot jail}. Related system calls are \texttt{mount()} and \texttt{unmount()}

\item UTS namespaces(\texttt{CLONE\_NEWUTS}) may be the most simple one to implement. It make containers to be able to have its own \texttt{nodename} and \texttt{domainname}\cite{lwn:namespace:overview}. Related system calls are \texttt{uname()}, \texttt{setnodename()} and \texttt{setdomainname()} 

\item IPC namespace(\texttt{CLONE\_NEWIPC}) isolate System V IPC objects and POSIX message queues, e.g. \texttt{sem, shm, msg}. 

\item PID namespace(\texttt{CLONE\_NEWPID}) isolate the process ID number space. Between different PID namespaces, processes can have the same PID. 
It is used to enable containers to be migrated to different host system while still keeping the same PID for processes inside that container. 
Processes inside a particular container, following the tradition of Linux(Unix) holds unique, sequentially assigned ID number.\cite{lwn:namespace:pid}

\item Network namespaces(\texttt{CLONE\_NEWNET}) isolate the entire network stack in Linux kernel. With help of network namespace, container can have its own network device, addresses, ports, routes, firewall rules, etc\cite{lwn:namespace:net}. 
It is widely applied in network emulation, Mininet\cite{mininet} for example, to create isolated network hosts.

\item User namespaces(\texttt{CLONE\_NEWUSER}) are the most complicated namespace, taking five years to complete, spanning from Linux 2.6.23 to Linux 3.8\cite{lwn:namespace:user}. 
The resource user namespace provided to process is its user ID with root privilege. 
A process can do full privilege operations inside its user namespace, even like creating other types of namespaces. Outside it user namespace, process can only do normal unprivileged operations.
\end{enumerate}
\subsection{Clock Namespaces}
Virtual time, by its definition, seems to fit into the category of namespace: it isolates time from the system wide wall clock so that a process can advance faster or slower by an offset or by a constant factor. 
If so, virtual time should actually be called \textbf{Clock Namespace}. However, a problem hangs here: virtual time is really a per process feature; there is no need to share time by a group of processes, like sharing network or file system. 
In other word, what can we do when we can identify that a group of processes belong to the same Clock namespace? We will see an unsatisfying answer in section \ref{Sub-Sec-Alg-Impl-Freeze}.

\subsection{Through Additional System Calls}
Probably the most straightforward and destructive way of exposing virtual time to user space is through modifying existing system calls and adding new system calls. Our first working implementation use this method to interfacing clock namespace\cite{yan:vts:pads15, yan:vtmininet:sosr15}.
To enable the virtual time perception to processes, we added/modified the following new system calls.
\begin{itemize}

\item \texttt{unshare()} system call with flag \texttt{CLONE\_NEWTIME} is modified. It is used by container-based emulators, such as Mininet, to create emulated nodes. 
When \texttt{CLONE\_NEWTIME} is set, \texttt{unshare()} creates a new process with a default TDF 1 in a different namespace from its parent process.

\item Newly added system call \texttt{set\_dilaiton()} offers an interface to change the TDF of a process. 

\item Newly added system call \texttt{freeze()} and \texttt{unfreeze()} comes as a combo to control the execution and pause of a process. Here pause is more than just send a signal \texttt{SIGSTOP} to process so that is stop executing; the process's clock, on freezing, actually is detached from OS's clock and is stopped. See section \ref{Sub-Sec-Alg-Impl-Freeze} for detail.

\end{itemize}
In container based network emulation, usually we want all processes inside the same container having the same time dilation factor. In other words, to keep the persistence, \texttt{set\_dilation()} should better set time dilation factor for a group of processes. We can take advantage of the identification of the \textit{network host}, who is usually the root of the process tree inside a particular container. We only invoke the \texttt{set\_dilation()} once for this \textit{root} process; as a leader in the container, it cascade \texttt{set\_dilation} further down to the process tree so that every process's TDF will be updated.

\subsection{Through Proc Virtual File System}
It is also possible to implement virtual time without adding system calls. Virtual file system provide a interface between kernel and user space. Since virtual time is a per process thing, it is more appropriate to create \texttt{/proc} file entry under the directory that specific to process.
\begin{itemize}
\item \texttt{/proc/\$pid/dilation} can be read and written so that process \texttt{\$pid} can enter virtual time(write non-zero value to zero TDF), exit virtual time(write zero to non-zero TDF) and change to new TDF.
\item \texttt{/proc/\$pid/freeze} expects a boolean value and freeze or unfreeze process \texttt{\$pid} according to the written value. 
\end{itemize}

\section{Algorithms and Implementations}
\subsection{Additional Data Structure}

\algrenewcommand{\algorithmiccomment}[1]{\hskip3em$/*$ #1 $*/$}
\subsection{Algorithm/Implementation for Set/Change Virtual Time Dilation}
\begin{algorithm*}[t]
\caption{Set Time Dilation Factor}
\label{Alg-SetTDF}
\begin{algorithmic}[1]
\Function{set\_dilation}{$tsk, \;new\_tdf$}\Comment{Set $new\_tdf$ to process $tsk$}
\State $old\_tdf \gets tsk.dilation$
\State $vsn \gets tsk.virtual\_start\_ns$
\If{$new\_tdf = old\_tdf$}
	\State return 0\Comment{do nothing}
\ElsIf{$old\_tdf = 0$}
	\State return \texttt{\uppercase{init\_virtual\_time}($tsk, new\_tdf$)}\Comment{enter virtual time with $new\_tdf$}
\ElsIf{$new\_tdf = 0$}
	\State return \texttt{\uppercase{clean\_up\_virtual\_time}($tsk$)}\Comment{exit virtual time}
\ElsIf{$new\_tdf > 0$}\Comment{real works here}
	\State $tsk.dilation \gets 0$
	\State $tsk.virtual\_start\_ns \gets 0$
	\State \texttt{\_\_getnstimeofday}($ts$)\Comment{$ts$: a \texttt{timespec} temp}
	\State $now \gets$ \texttt{timespec\_to\_ns}($ts$)
	\State $tsk.virtual\_start\_ns \gets vsn$
	\State $delta\_ppn \gets now \; - \; tsk.physical\_past\_ns \; - \; tsk. physical\_start\_ns \; - \; tsk. freeze\_past\_ns$
	\State $delta\_vpn \gets delta\_ppn \; / \; old\_tdf$
	\State $tsk.virtual\_past\_ns \; += \; delta\_vpn$
	\State $tsk.physical\_start\_ns \gets (now \; - \; tsk\rightarrow freeze\_past\_ns)$
	\State $tsk.physical\_past\_ns \gets 0$
	\State $tk.dilation \gets new\_tdf$
	\State return 0
\Else
	\State return \texttt{-EINVAL}
\EndIf
\EndFunction
\end{algorithmic}
\end{algorithm*}

\subsection{Algorithm/Implementation for Freeze and Unfreeze}
\label{Sub-Sec-Alg-Impl-Freeze}
\begin{algorithm}[t]
\caption{Freeze and Unfreeze Process}
\label{Alg-Freeze}
\begin{algorithmic}[1]
\Function{Freeze}{tsk}
\State \texttt{kill\_pgrp(task\_pgrp($tsk$), SIGSTOP, 1)}
\State \texttt{\_\_getnstimeofday}($ts$)\Comment{\texttt{timespec} $ts$}
\State $now \gets$ \texttt{timespec\_to\_ns}($ts$)
\State $tsk.freeze\_start\_ns \gets now$
\EndFunction
\\
\Function{Unfreeze}{tsk}
\State \texttt{\_\_getnstimeofday}(\&$ts$)\Comment{\texttt{timespec} $ts$}
\State $now \gets$ \texttt{timespec\_to\_ns}($ts$)
\State $tsk.freeze\_past\_ns \gets now \; - \; tsk.freeze\_start\_ns$
\State $tsk.freeze\_start\_ns \gets 0$
\State \texttt{kill\_pgrp(task\_pgrp($tsk$), SIGCONT, 1)}
\EndFunction
\end{algorithmic}
\end{algorithm}

\subsection{Algorithm/Implementation for Virtual Time Keeping}
\begin{algorithm*}[t]
\caption{Time Dilation Algorithm}%: Dilate \texttt{ts} if a current process uses virtual clock}
\label{Alg-DilateTimeKeeping}
\begin{algorithmic}[1]
\Function{init\_virtual\_time}{$tsk,\;tdf$}
\If{$tdf>0$}
    \State $tk.dilation \gets tdf$
    \State $tk.virtual\_start\_ns \gets 0$
    \State \texttt{\_\_getnstimeofday($ts$)}\Comment{$ts$: a \texttt{timespec} temp}
    \State $tk.virtual\_start\_ns \gets $\texttt{timespec\_to\_ns($ts$)}
    \State $tk.physical\_past\_ns \gets 0$
    \State $tk.virtual\_past\_ns \gets 0$
\EndIf
\EndFunction
\\
\Function{update\_physical\_time}{$tsk, \;ts$}\Comment{interval between }
\State $leader \gets tsk.group_leader$
\State $now \gets \texttt{timespec\_to\_ns($ts$)}$
\State $delta\_ppn \gets now \; - \; tsk.physical\_past\_ns \; - \; tsk.physical\_start\_ns$
\State $delta\_ppn \; -= \; leader.freeze\_past\_ns$
\State $tsk.physical\_past\_ns \; += \; delta\_ppn$
\State return $delta\_ppn$
\EndFunction
\\
\Function{update\_virtual\_time}{$delta\_ppn, \;tdf$}
\If{$tdf \neq 0$}
	\State $delta\_vpn \gets delta\_ppn \; / \; tdf$
	\State $tsk.virtual\_past\_ns \; += \; delta\_vpn$
\EndIf
\EndFunction
\\
\Function{do\_virtual\_time\_keeping}{$tsk, \;ts$}\Comment{\texttt{timespec} $ts$ will be modified}
\If{$tsk.virtual\_start\_ns > 0$}
	\State $tdf \gets tsk.dilation$
	\State $delta\_ppn \gets \texttt{\uppercase{update\_physical\_time}($ts$)}$
	\State \texttt{\uppercase{update\_virtual\_past\_time}($delta\_ppn, \;tdf$)}
	\State $virtual\_now \gets tsk.virtual\_start\_ns + tsk.virtual\_past\_ns$
	\State $virtual\_ts \gets \texttt{ns\_to\_timespec(virtual\_now)}$
	\State $ts.tv\_sec \gets virtual\_ts.tv\_sec$
	\State $ts.tv\_nsec \gets virtual\_ts.tv\_nsec$
\EndIf
\EndFunction
\end{algorithmic}
\end{algorithm*}

\section{Miscellaneous Parts}
\subsection{Bypass virtual Dynamic Shared Object}
\subsection{Dilate Bandwidth Rate in Traffic Control}

\section{Tests and Overhead Measurements}

\section{Conclusions}
TODO

\section{Acknowledgments}
TODO
%
% The following two commands are all you need in the
% initial runs of your .tex file to
% produce the bibliography for the citations in your paper.
\bibliographystyle{abbrv}
\bibliography{vt_doc}
% You must have a proper ".bib" file
%  and remember to run:
% latex bibtex latex latex
% to resolve all references
%
% ACM needs 'a single self-contained file'!
%
\balancecolumns
% That's all folks!
\end{document}
